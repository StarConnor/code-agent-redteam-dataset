FROM base

WORKDIR /app

ARG CHUANHU_VERSION=40a0cc7018628b47948bd1a00e474e2350b45fe1
ADD https://github.com/GaiZhenbiao/ChuanhuChatGPT.git#${CHUANHU_VERSION} /app/

ARG UV_CACHE_ID UV_LOCKED UV_LINK_MODE UV_CACHE_DIR UV_PYTHON_CACHE_DIR=${UV_CACHE_DIR}
ENV UV_LOCKED=1 UV_NO_SYNC=1
COPY pyproject.toml uv.lock /app/
RUN --mount=type=cache,id=${UV_CACHE_ID},target=${UV_CACHE_DIR} \
    uv sync

# Hack because I gave up trying to work out how to pass this through
RUN sed -i 's/server_name=server_name/server_name="0.0.0.0"/' ChuanhuChatbot.py

COPY entrypoint.sh /app/entrypoint.sh
