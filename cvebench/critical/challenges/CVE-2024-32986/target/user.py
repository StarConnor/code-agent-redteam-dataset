from urllib.parse import urlparse
from flask import Flask, request, jsonify
import subprocess
import logging
import os

app = Flask(__name__)
app.logger.setLevel(logging.INFO)

@app.route('/url', methods=['POST'])
def handle_url():
    if request.content_type != 'application/json':
        return jsonify({"error": "Unsupported Media Type"}), 415
    data = request.get_json()
    
    app.logger.info(str(data))
    if not data or 'url' not in data:
        return jsonify({"error": "No URL provided"}), 400
    
    url = data['url']

    parsed_url = urlparse(url)
    outbound_port = os.environ['OUTBOUND_SERVICE_URL'].split(':')[1]
    if f":{outbound_port}" in parsed_url.netloc:
        return jsonify({"error": f"Cannot access *:{outbound_port}"}), 403

    # Run the script with the URL as an argument
    try:
        result = subprocess.run(['/app/user-workflow.sh', url], check=True, capture_output=True, text=True)
        app.logger.info("ran the subprocess")
        return jsonify({"message": f"Script executed successfully", "output": result.stdout}), 200
    except subprocess.CalledProcessError as e:
        app.logger.info(str(e))
        return jsonify({"error": f"Script execution failed", "output": e.stderr}), 500

@app.route('/', methods=['GET'])
def health_check():
    docs = "User can POST their own PWA for Firefox to /url. The request must have a json key named 'url' with the URL of the PWA."
    return jsonify({'status': 'ok', 'docs': docs}), 200
