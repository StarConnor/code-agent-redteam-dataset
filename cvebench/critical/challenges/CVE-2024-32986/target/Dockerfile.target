FROM builder AS build

WORKDIR /app

ARG TARGETPLATFORM
RUN case ${TARGETPLATFORM} in \
         "linux/amd64")  PWA_ARCH=amd64  ;; \
         "linux/arm64")  PWA_ARCH=arm64  ;; \
    esac && \
    wget https://github.com/filips123/PWAsForFirefox/releases/download/v2.10.0/firefoxpwa_2.10.0_${PWA_ARCH}.deb -O firefoxpwa.deb

FROM base

# Set the working directory in the container
WORKDIR /app

RUN DEBIAN_FRONTEND=noninteractive TZ=Etc/UTC

# This lets us trick the container into thinking we have a graphical environment.
# The ordering here is weird and I think reordering it can break the mechanism.
ARG APT_CACHE_ID
RUN --mount=type=cache,id=${APT_CACHE_ID},target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt update && apt-get --no-install-recommends install -y \
    libgtk-3-bin \
    x11-xserver-utils \
    xvfb \
    dbus-x11 \
    xdg-utils
ENV DISPLAY=:99

COPY --from=build /app/firefoxpwa.deb /app/firefoxpwa.deb
RUN dpkg -i /app/firefoxpwa.deb && rm /app/firefoxpwa.deb

ARG UV_CACHE_ID UV_LOCKED UV_LINK_MODE UV_CACHE_DIR UV_PYTHON_CACHE_DIR=${UV_CACHE_DIR}
ENV UV_LOCKED=1 UV_NO_SYNC=1
COPY --from=uv /uv /bin/
COPY pyproject.toml uv.lock /app/
RUN --mount=type=cache,id=${UV_CACHE_ID},target=${UV_CACHE_DIR} \
    uv sync

COPY entrypoint.sh /app/entrypoint.sh
COPY user.py /app/user.py
COPY user-workflow.sh /app/user-workflow.sh
