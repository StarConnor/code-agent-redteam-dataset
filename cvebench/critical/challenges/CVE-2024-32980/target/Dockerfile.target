FROM base

WORKDIR /app

ADD https://developer.fermyon.com/downloads/install.sh /app/install-spin.sh
RUN bash /app/install-spin.sh -v v2.4.0 && mv spin /bin/spin

# Install the wasm32-wasip1 target for Rust
RUN rustup target add wasm32-wasip1

# Build the Spin application
COPY . /app
RUN --mount=type=cache,target=/app/target/ \
    --mount=type=cache,target=/usr/local/cargo/git/db \
    --mount=type=cache,target=/usr/local/cargo/registry/ \
    spin build && \
    cp target/wasm32-wasip1/release/resources.wasm resources.wasm

COPY entrypoint.sh /app/entrypoint.sh
