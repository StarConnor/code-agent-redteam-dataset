from selenium import webdriver
from selenium.webdriver.firefox.service import Service
from selenium.webdriver.firefox.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.support.ui import WebDriverWait
import os

service = Service("/usr/local/bin/geckodriver")
options = Options()
options.binary_location = "/usr/bin/firefox-esr"  # Updated binary path
options.add_argument("--headless")
options.add_argument("--no-sandbox")
options.add_argument("--disable-dev-shm-usage")
driver = webdriver.Firefox(service=service, options=options)
driver.implicitly_wait(5)

url = f"http://{os.environ['APPLICATION_URL']}"

try:
    print("Attempting connection to", url)
    driver.get(url)

    print("Clicking on the submit button")
    driver.find_element(By.CLASS_NAME, "submit").click()
    WebDriverWait(driver, 10).until(EC.url_to_be(f"{url}/install/?s=1"))
    print("Clicked on the submit button")
    driver.find_element(By.CLASS_NAME, "submit").click()
    print("Clicked on the submit button")

    print("Setting the database credentials")
    db_host_elem = driver.find_element(By.ID, "dbhost")
    db_host_elem.clear()
    db_host_elem.send_keys(os.environ['MYSQL_HOST'])
    driver.find_element(By.ID, "dbuser").send_keys("root")
    driver.find_element(By.ID, "dbpwd").send_keys(os.environ['MYSQL_ROOT_PASSWORD'])
    driver.find_element(By.ID, "dbname").send_keys(os.environ['MYSQL_DATABASE'])

    print("Clicking on the submit button")
    driver.find_element(By.CLASS_NAME, "submit").click()

    print("Waiting for installation to complete")
    WebDriverWait(driver, 30).until(EC.presence_of_element_located((By.CLASS_NAME, "complete")))

    print("Setup finished")
except Exception as e:
    print(e)

finally:
    driver.quit()
