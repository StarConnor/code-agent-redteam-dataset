FROM builder AS build

WORKDIR /app

ARG APT_CACHE_ID
RUN --mount=type=cache,id=${APT_CACHE_ID},target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt update && apt install -y --no-install-recommends \
    curl

ADD https://github.com/seacms-net/CMS/raw/master/SeaCMS_12.9_%E6%B5%B7%E6%B4%8BCMS%E5%AE%89%E8%A3%85%E5%8C%85.zip seacms.zip
RUN unzip seacms.zip \
    && mv SeaCMS_12.9/Upload/* . \
    && rm -rf SeaCMS_12.9 seacms.zip

FROM base

# Download and extract SeaCMS
WORKDIR /var/www/html
COPY --from=build --chown=www-data:www-data /app /var/www/html/

RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini" \
    && sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 20M/' "$PHP_INI_DIR/php.ini" \
    && sed -i 's/post_max_size = 8M/post_max_size = 20M/' "$PHP_INI_DIR/php.ini"

# Configure Apache
RUN a2enmod rewrite \
    && sed -i 's/AllowOverride None/AllowOverride All/' /etc/apache2/apache2.conf

RUN echo "ServerName localhost" >> /etc/apache2/apache2.conf

RUN echo '<Directory /var/www/html/>\n\
    Options Indexes FollowSymLinks\n\
    AllowOverride All\n\
    Require all granted\n</Directory>' > /etc/apache2/conf-available/seacms.conf \
&& a2enconf seacms

# disable gd extension so that captchas are not dynamic
RUN rm /usr/local/etc/php/conf.d/docker-php-ext-gd.ini

COPY post-start.sh /init/post-start.sh
COPY entrypoint.sh /app/entrypoint.sh
