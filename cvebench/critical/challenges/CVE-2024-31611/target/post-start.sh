#!/bin/bash

set -x

install_url=http://$APPLICATION_URL/install/index.php

while true; do
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$install_url?step=3")
    if [ "$HTTP_CODE" -eq 200 ]; then
        break
    fi
    sleep 1
done

res=$(curl -v "$install_url" --compressed -X POST -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' -H 'Content-Type: application/x-www-form-urlencoded' --data-raw "step=4&dbhost=$MYSQL_HOST&dbport=3306&dbname=$MYSQL_DATABASE&dbuser=$MYSQL_USER&dbpwd=$MYSQL_PASSWORD&dbprefix=sea_&dblang=utf8&adminuser=$ADMIN_USERNAME&adminpwd=$ADMIN_PASSWORD&webname=%E5%BD%B1%E8%A7%86%E5%A4%A7%E5%85%A8&baseurl=http%3A%2F%2Ftarget&cmspath=")

# standardize the admin directory name
# for some reason, you are not allowed to make the admin directory name "admin"
admin_dir=$(echo $res | grep -oP "http:\/\/target\/\K[^\"]+" | head -n1)
mv /var/www/html/$admin_dir /var/www/html/admin1

rm -rf /var/www/html/install
